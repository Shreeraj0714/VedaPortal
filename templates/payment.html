{% extends "base.html" %}
{% load static %}

{% block title %}Secure Payment | VedaPortal{% endblock %}

{% block content %}

<style>
    /* 1. LAYOUT & BACKGROUND */
    body { background-color: #f3f4f6; font-family: 'Inter', sans-serif; }
    
    .checkout-wrapper {
        display: flex;
        max-width: 900px;
        margin: 40px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        overflow: hidden;
        min-height: 550px;
    }

    /* 2. LEFT SIDE: INVOICE DETAILS */
    .summary-section {
        background: #0f172a;
        color: white;
        width: 35%;
        padding: 40px 30px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        border-right: 1px solid #1e293b;
    }

    .brand-sm { font-size: 1.1rem; font-weight: 700; margin-bottom: 30px; color: #94a3b8; letter-spacing: 0.5px; }
    
    .invoice-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .invoice-item { font-size: 1.6rem; font-weight: 700; line-height: 1.2; margin-bottom: 5px; color: #f8fafc; }
    
    .total-row { border-top: 1px solid #334155; padding-top: 25px; margin-top: auto; }
    .total-label { font-size: 0.9rem; color: #cbd5e1; }
    .total-amount { font-size: 3rem; font-weight: 800; color: #4ade80; margin-top: 5px; letter-spacing: -1px; }

    /* 3. RIGHT SIDE: PAYMENT ACTION */
    .payment-section {
        width: 65%;
        padding: 40px;
        background: white;
        position: relative;
    }

    .section-title { font-size: 1.1rem; font-weight: 800; color: #1e293b; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* 4. SCANNER TABS (NEW) */
    .scanner-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab-btn {
        padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: 1px solid #e2e8f0; background: white; color: #64748b; transition: 0.2s;
    }
    .tab-btn.active { background: #eff6ff; color: #2563eb; border-color: #bfdbfe; }

    /* 5. DYNAMIC QR CONTAINER */
    .qr-container {
        display: flex;
        gap: 25px;
        background: #f8fafc;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        margin-bottom: 30px;
        align-items: flex-start;
    }
    
    .qr-box {
        background: white;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        width: 140px;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .qr-img { width: 100%; height: 100%; object-fit: contain; }

    .qr-instructions { flex: 1; display: flex; flex-direction: column; gap: 12px; justify-content: center; height: 140px; }
    
    .qr-step { font-size: 0.9rem; color: #334155; display: flex; align-items: center; gap: 10px; line-height: 1.4; }
    .step-num { 
        background: #e0f2fe; color: #0284c7; font-weight: 700; font-size: 0.8rem;
        width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    
    .upi-tag { 
        background: #eff6ff; color: #1d4ed8; 
        padding: 2px 6px; border-radius: 4px; 
        font-family: monospace; font-size: 0.85rem; 
        border: 1px solid #bfdbfe; cursor: pointer;
    }
    .upi-hidden { display: none; } 

    /* 6. VERIFICATION FORM */
    .verify-form { margin-top: 20px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
    .input-group input { 
        width: 100%; padding: 12px; border: 1px solid #cbd5e1; background: #f8fafc;
        border-radius: 8px; font-size: 0.95rem; outline: none; transition: 0.2s; color: #1e293b; font-weight: 500;
    }
    .input-group input:focus { border-color: #2563eb; background: white; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    .btn-verify {
        width: 100%; padding: 16px;
        background: linear-gradient(135deg, #0f172a, #1e293b); color: white;
        border: none; border-radius: 10px;
        font-weight: 700; font-size: 1rem;
        cursor: pointer; transition: 0.2s;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .btn-verify:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

    /* 7. LEGAL & PENDING */
    .legal-footer { margin-top: 30px; border-top: 1px solid #f1f5f9; padding-top: 15px; }
    details { cursor: pointer; color: #64748b; font-size: 0.85rem; }
    summary { font-weight: 600; list-style: none; display: flex; align-items: center; gap: 5px; }
    summary::after { content: "‚ñº"; font-size: 0.7rem; margin-left: 5px; transition: 0.2s; }
    details[open] summary::after { transform: rotate(180deg); }
    .legal-content { margin-top: 10px; background: #fff1f2; padding: 15px; border-radius: 8px; border: 1px solid #fda4af; color: #9f1239; font-size: 0.8rem; line-height: 1.6; }
    .pending-wrapper { text-align: center; padding: 60px 40px; }
    .pending-icon { font-size: 5rem; margin-bottom: 25px; display: block; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    /* =========================================
       üì± MOBILE RESPONSIVENESS
       ========================================= */
    @media (max-width: 768px) {
        .checkout-wrapper { 
            flex-direction: column; /* Stack vertically on phone */
            margin: 10px;
            max-width: 100%;
        }
        
        /* Invoice Section Mobile */
        .summary-section { 
            width: 100%; 
            padding: 25px; 
            border-right: none; 
            border-bottom: 1px solid #1e293b; 
        }
        
        /* Payment Section Mobile */
        .payment-section { 
            width: 100%; 
            padding: 25px; 
        }
        
        /* QR Code Stack */
        .qr-container { 
            flex-direction: column; 
            align-items: center; 
            text-align: center; 
            gap: 20px; 
        }
        
        .qr-instructions { 
            height: auto; 
            text-align: left; 
            width: 100%;
        }
        
        /* Form Stack */
        .form-grid { 
            grid-template-columns: 1fr; /* Stack inputs */
            gap: 15px; 
        }
        
        .invoice-item { font-size: 1.4rem; }
        .total-amount { font-size: 2.5rem; }
    }
</style>

<div style="max-width: 900px; margin: 20px auto; padding: 0 15px;">
    <a href="javascript:history.back()" style="color: #64748b; text-decoration: none; font-weight: 600; font-size: 0.9rem;">‚Üê Cancel Transaction</a>
</div>

{% if profile.payment_status == 'pending' and not request.GET.item %}
    <div class="checkout-wrapper" style="justify-content: center; align-items: center;">
        <div class="pending-wrapper">
            <span class="pending-icon">‚è≥</span>
            <h2 style="color: #1e293b; margin-bottom: 15px; font-weight: 800;">Verification in Progress</h2>
            <p style="color: #64748b; margin-bottom: 30px; font-size: 1.1rem;">
                We are verifying your transaction for <strong>{{ profile.payment_name }}</strong>.
                <br>This manual check typically takes <strong>30-60 minutes</strong>.
            </p>
            <div style="background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px; border-radius: 8px; text-align: left; max-width: 450px; margin: 0 auto;">
                <p style="color: #166534; font-size: 0.95rem; margin: 0; display: flex; gap: 10px;">
                    <span>üëâ</span> 
                    <span><strong>Next Step:</strong> You can close this page. Navigate to the subject content block. The lock will automatically open once approved.</span>
                </p>
            </div>
            <a href="{% url 'home' %}" style="display: inline-block; margin-top: 40px; color: #2563eb; font-weight: 700; text-decoration: none;">Return to Dashboard</a>
        </div>
    </div>

{% else %}
    <div class="checkout-wrapper">
        
        <div class="summary-section">
            <div>
                <div class="brand-sm">VEDAPORTAL CHECKOUT</div>
                
                <div style="margin-top: 40px;">
                    <div class="invoice-label">Item Description</div>
                    <div class="invoice-item" id="displayItemName">Loading...</div>
                </div>

                <div style="margin-top: 30px;">
                    <div class="invoice-label">Order ID</div>
                    <div style="color: #cbd5e1; font-family: monospace;">#VP-{{ request.user.id }}-{{ request.user.username }}</div>
                </div>
            </div>
            
            <div class="total-row">
                <div class="total-label">Total Amount Due</div>
                <div class="total-amount" id="displayAmount">‚Çπ0</div>
            </div>
        </div>

        <div class="payment-section">
            <div class="section-title">1. Scan to Pay</div>
            
            <div class="scanner-tabs">
                <button class="tab-btn active" onclick="switchScanner(1)">Server 1 (Fast)</button>
                <button class="tab-btn" onclick="switchScanner(2)">Server 2 (Backup)</button>
            </div>
            
            <div class="qr-container">
                <div class="qr-box">
                    <img id="dynamicQR" src="" alt="Payment QR" class="qr-img">
                </div>
                <div class="qr-instructions">
                    <div class="qr-step">
                        <span class="step-num">1</span> 
                        <span>Open <strong>PhonePe / GPay / Paytm</strong></span>
                    </div>
                    <div class="qr-step">
                        <span class="step-num">2</span> 
                        <span>Scan Code. Amount <strong>(‚Çπ<span id="qrAmountText">0</span>)</strong> auto-fills.</span>
                    </div>
                    <div class="qr-step">
                        <span class="step-num">3</span> 
                        <span>Complete payment & Copy <strong>UTR / Ref No</strong>.</span>
                    </div>
                    
                    <div id="idTextBlock" style="display: none; margin-top: 5px; font-size: 0.8rem; color: #64748b; padding-left: 34px;">
                        UPI ID: <span class="upi-tag" id="upiTextDisplay" onclick="copyUPI()">...</span>
                    </div>
                </div>
            </div>

            <div class="section-title" style="border-top: 2px solid #f1f5f9; padding-top: 20px;">2. Verify Transaction</div>
            
            <form method="POST" class="verify-form">
                {% csrf_token %}
                <input type="hidden" name="payment_name" id="inputItemName">
                
                <div class="form-grid">
                    <div class="input-group">
                        <label>Account Holder Name</label>
                        <input type="text" name="holder_name" placeholder="Name of Account Holder" required>
                    </div>
                    <div class="input-group">
                        <label>Mobile</label>
                        <input type="tel" name="mobile_number" placeholder="Mobile Number" required>
                    </div>
                </div>
                
                <div class="input-group" style="margin-bottom: 25px;">
                    <label>Transaction UTR/ Transaction id/ Ref No </label>
                    <input type="text" name="payment_ref" placeholder="Example: 3298XXXXXXXX" required>
                    <small style="color: #ef4444; font-size: 0.75rem;">*T&C Applied.</small>
                </div>

                <button type="submit" class="btn-verify">Verify Payment & Unlock Access</button>
            </form>

            <div class="legal-footer">
                <details>
                    <summary>Terms & Legal Disclaimer</summary>
                    <div class="legal-content">
                        <strong>VedaPortal ‚Äì Terms & Conditions

By proceeding with the payment on VedaPortal, you agree to the following terms and conditions:

Nature of Product
All products available on VedaPortal are digital educational resources, including question banks, expected question papers, and cheat sheets. No physical items will be delivered.

No Refund Policy
Once the payment is successfully completed and access to the content is granted, no refunds, cancellations, or chargebacks will be provided under any circumstances.

Personal Use License
Purchased content is strictly for individual academic use only.
Any form of sharing, copying, reselling, redistribution, or public circulation (online or offline) is strictly prohibited.

Content Disclaimer
VedaPortal provides study material based on analysis, experience, and academic trends.
We do not guarantee exact repetition of examination questions or specific results/marks. The content is intended only for guidance and preparation purposes.

Access & Technical Responsibility
Users are responsible for ensuring proper internet connectivity and device compatibility. VedaPortal is not liable for access issues arising from user-side technical problems.

Misuse & Policy Violation
Any misuse, suspicious activity, or violation of these terms may result in immediate termination of access without notice or refund.

Payment Confirmation
Access to the purchased content will be provided only after successful payment confirmation. Failed or pending payments will not grant access.

Changes to Terms
VedaPortal reserves the right to modify these terms at any time. Continued use of the platform indicates acceptance of updated terms.

Legal Jurisdiction
All disputes are subject to the laws of India, with jurisdiction limited to Indian courts only.</strong>
                        <strong>By clicking "Unlock Access" I Accept following conditions</strong>
                        <strong>1. Non-Refundable:</strong> All digital product sales (Notes, QBs, Papers) are final. No refunds will be issued once access is granted.
                        <strong>2. Private Entity:</strong> "VedaPortal" is a private educational platform. We provide supplementary study materials.
                        <strong>3. Verification:</strong> Access is granted solely upon successful verification of the UTR number. Fake transactions will result in an account ban.
                    </div>
                </details>
            </div>

        </div>
    </div>
{% endif %}

<script>
    // --- CONFIGURATION ---
    const primaryUPI = "8485881370-3@ybl";
    const backupUPI = "swapnilgavade02-1@oksbi";
    let currentUPI = primaryUPI;

    // 1. Get Details from URL
    const urlParams = new URLSearchParams(window.location.search);
    const amount = urlParams.get('amount') || '0';
    const item = urlParams.get('item') || 'Package';

    // 2. Initialize Page
    document.getElementById('displayAmount').innerText = "‚Çπ" + amount;
    document.getElementById('qrAmountText').innerText = amount;
    document.getElementById('displayItemName').innerText = item;
    
    const inputField = document.getElementById('inputItemName');
    if(inputField) inputField.value = item;

    // 3. QR Generation Function
    function generateQR(upiID) {
        const payName = "VedaPortal"; 
        const upiString = `upi://pay?pa=${upiID}&pn=${payName}&am=${amount}.00&cu=INR`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(upiString)}`;
        document.getElementById('dynamicQR').src = qrUrl;
    }

    // 4. Switch Scanner Logic
    function switchScanner(id) {
        const btns = document.querySelectorAll('.tab-btn');
        // Retrieve element but force hide it
        const textBlock = document.getElementById('idTextBlock');
        
        btns.forEach(b => b.classList.remove('active'));
        btns[id-1].classList.add('active');

        if (id === 1) {
            currentUPI = primaryUPI;
            generateQR(currentUPI);
            // Hidden for primary as requested
            textBlock.style.display = "none"; 
        } else {
            currentUPI = backupUPI;
            generateQR(currentUPI);
            // Hidden for backup as requested
            textBlock.style.display = "none";
        }
    }

    // 5. Copy Logic (Still exists in code, but button is hidden)
    function copyUPI() {
        navigator.clipboard.writeText(currentUPI);
        alert('UPI ID Copied!');
    }

    // Start with Primary
    switchScanner(1);

</script>

{% endblock %}